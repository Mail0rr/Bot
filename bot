import asyncio
import logging
import sys
from config import BOT_TOKEN as TOKEN

from aiogram import Bot, Dispatcher, html
from aiogram.client.default import DefaultBotProperties
from aiogram.enums import ParseMode
from aiogram.filters import CommandStart
from aiogram.types import Message, CallbackQuery, InlineKeyboardMarkup, InlineKeyboardButton
from youtubesearchpython import VideosSearch
from aiogram.client.session.aiohttp import AiohttpSession


import Spotify_API


logging.basicConfig(level=logging.INFO, stream=sys.stdout)

session = AiohttpSession(proxy='http://proxy.server:3128')

dp = Dispatcher()



# Ð¡Ñ‚Ð°Ñ€Ñ‚ Ð±Ð¾Ñ‚Ð°
@dp.message(CommandStart())
async def start_bot(message: Message) -> None:
    await message.answer(f"ðŸ‘‹ ÐŸÑ€Ð¸Ð²ÐµÑ‚, {html.bold(message.from_user.full_name)}! ðŸ‘‹\n"
                         "ðŸ‘€ Ð¯ Ð¼Ð¾Ð³Ñƒ Ð¸ÑÐºÐ°Ñ‚ÑŒ Ð¸ ÑÐºÐ°Ñ‡Ð¸Ð²Ð°Ñ‚ÑŒ Ð¼ÑƒÐ·Ñ‹ÐºÑƒ Ð¸ Ð²Ð¸Ð´ÐµÐ¾ ðŸ“©\n"
                         "ðŸŽžï¸ YouTube Ð¸Ð»Ð¸ Spotify ðŸŽ¶\n"
                         "ðŸŽžï¸ ÐšÐ¸Ð´Ð°Ð¹ Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ðµ Ð¸Ð»Ð¸ Ñ‚ÐµÐ¼Ñƒ Ñ‚Ð¾Ð³Ð¾, Ñ‡Ñ‚Ð¾ Ñ…Ð¾Ñ‡ÐµÑˆÑŒ Ð¿Ð¾ÑÐ¼Ð¾Ñ‚Ñ€ÐµÑ‚ÑŒ Ð¸Ð»Ð¸ Ð¿Ð¾ÑÐ»ÑƒÑˆÐ°Ñ‚ÑŒ!ðŸŽ¶\n"
                         "ðŸ“º Ð•ÑÐ»Ð¸ Ð²Ð¸Ð´ÐµÐ¾ Ñ Youtube, Ñ‚Ð¾ Ð¿ÐµÑ€ÐµÐ´ Ð½Ð°Ð·Ð²Ð°Ð½Ð¸ÐµÐ¼ Ð¿Ð¸ÑˆÐ¸ 'yt'! ðŸ“º\n"
                         "ðŸ“» Ð•ÑÐ»Ð¸ Ð¼ÑƒÐ·Ñ‹ÐºÐ° ÑÐ¾ Spotify, Ñ‚Ð¾ Ð¿ÐµÑ€ÐµÐ´ Ð½Ð°Ð·Ð²Ð°Ð½Ð¸ÐµÐ¼ Ð¿Ð¸ÑˆÐ¸ 'sf' ðŸ“»")


@dp.message(lambda message: message.text.startswith("yt"))
async def handle_youtube_search(message: Message):
    search_query = message.text[len("yt "):]
    try:
        search_list = VideosSearch(search_query, limit=6).result()['result']
        keyboard = [[InlineKeyboardButton(text=element['title'], callback_data=element['link'])] for element in search_list]
        choose_markup = InlineKeyboardMarkup(inline_keyboard=keyboard)
        await message.answer("ðŸ‘€ Ð’Ð¾Ñ‚ Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶ÐµÐ½Ð½Ñ‹Ðµ Ð²Ð°Ð¼ Ð²Ð¸Ð´ÐµÐ¾:\n", reply_markup=choose_markup)
    except Exception as e:
        await message.answer(f"ÐŸÑ€Ð¾Ð¸Ð·Ð¾ÑˆÐ»Ð° Ð¾ÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¿Ð¾Ð¸ÑÐºÐµ Ð²Ð¸Ð´ÐµÐ¾: {e}")
        logging.error(f"ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¿Ð¾Ð¸ÑÐºÐµ Ð½Ð° YouTube: {e}")


@dp.callback_query()
async def callback_handler(query: CallbackQuery):
    download_markup = InlineKeyboardMarkup(inline_keyboard=[[InlineKeyboardButton(text="ðŸ“¥ Ð¡ÐºÐ°Ñ‡Ð°Ñ‚ÑŒ Ð²Ð¸Ð´ÐµÐ¾ Ð¼Ð¾Ð¶Ð½Ð¾ Ñ‚ÑƒÑ‚ ðŸ“¥", url='https://ru.savefrom.net/')]])
    await query.message.answer(
        f"ðŸ“º ÐŸÑ€Ð¸ÑÑ‚Ð½Ð¾Ð³Ð¾ Ð¿Ñ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€Ð°:\n {query.data}\n"
        "Ð•ÑÐ»Ð¸ Ñ…Ð¾Ñ‚Ð¸Ñ‚Ðµ ÑÐºÐ°Ñ‡Ð°Ñ‚ÑŒ Ð²Ð¸Ð´ÐµÐ¾, ÑÑ‚Ð¾ Ð¼Ð¾Ð¶ÐµÑ‚Ðµ ÑÐ´ÐµÐ»Ð°Ñ‚ÑŒ Ð½Ð° ÑÑ‚Ð¾Ð¼ ÑÐ°Ð¹Ñ‚Ðµ:",
        reply_markup=download_markup
    )
    await query.answer()


@dp.message(lambda message: message.text.startswith("sf"))
async def music_from_spotify(message: Message):
    query = message.text[len("f "):]
    try:
        logging.info(f"Ð—Ð°Ð¿Ñ€Ð¾Ñ Ðº Spotify > {query}")
        tracks = Spotify_API.search_tracks(query)

        if tracks:
            response = "ðŸŽµ ÐÐ°Ð¹Ð´ÐµÐ½Ð½Ñ‹Ðµ Ñ‚Ñ€ÐµÐºÐ¸:\n\n"
            keyboard = []

            for track in tracks:
                track_name = track['name']
                artists = ', '.join([artist['name'] for artist in track['artists']])
                download_url = track['external_urls']['spotify']
                response += f"{html.bold(track_name)} by {html.italic(artists)}\n"

                keyboard.append([InlineKeyboardButton(text=f"Ð¡ÐºÐ°Ñ‡Ð°Ñ‚ÑŒ {track_name}", url=download_url)])

            choose_markup = InlineKeyboardMarkup(inline_keyboard=keyboard)

            await message.answer(response, reply_markup=choose_markup)
        else:
            await message.answer("Ð¢Ñ€ÐµÐºÐ¸ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ñ‹.")

    except Exception as e:
        await message.answer(f"ÐŸÑ€Ð¾Ð¸Ð·Ð¾ÑˆÐ»Ð° Ð¾ÑˆÐ¸Ð±ÐºÐ°: {e}")
        logging.error(f"ÐžÑˆÐ¸Ð±ÐºÐ° Spotify API: {e}")


async def main() -> None:
    bot = Bot(token=TOKEN, default=DefaultBotProperties(parse_mode=ParseMode.HTML))
#    bot = Bot(token=TOKEN, session=session, default=DefaultBotProperties(parse_mode=ParseMode.HTML))
    await dp.start_polling(bot)



if __name__ == "__main__":
    asyncio.run(main())
